<!DOCTYPE HTML>

<html>
	<head>
		<title>E-tube</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="html5/assets/css/main.css" />
    <style>
		ul, li{
        list-style:none;
        padding:0;
        margin:0;
			}
		#liSearchOption {clear:both;}
		#liSearchOption > div {
				margin:0 auto;
				margin-top: 30px;
				width:auto;
				height:100px;

			}
      body {margin: 10px;}
.where {
  display: block;
  margin: 25px 15px;
  font-size: 11px;
  color: #000;
  text-decoration: none;
  font-family: verdana;
  font-style: italic;
}

.filebox input[type="file"] {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip:rect(0,0,0,0);
  border: 0;
}

.filebox label {
  display: inline-block;
  padding: .5em .75em;
  color: #999;
  font-size: inherit;
  line-height: normal;
  vertical-align: middle;
  background-color: #fdfdfd;
  cursor: pointer;
  border: 1px solid #ebebeb;
  border-bottom-color: #e2e2e2;
  border-radius: .25em;
}

/* named upload */
.filebox .upload-name {
  display: inline-block;
  padding: .5em .75em;
  font-size: inherit;
  font-family: inherit;
  line-height: normal;
  vertical-align: middle;
  background-color: #f5f5f5;
  border: 1px solid #ebebeb;
  border-bottom-color: #e2e2e2;
  border-radius: .25em;
  -webkit-appearance: none; /* 네이티브 외형 감추기 */
  -moz-appearance: none;
  appearance: none;
}

/* imaged preview */
.filebox .upload-display {
  margin-bottom: 5px;
}

@media(min-width: 768px) {
  .filebox .upload-display {
    display: inline-block;
    margin-right: 5px;
    margin-bottom: 0;
  }
}

.filebox .upload-thumb-wrap {
  display: inline-block;
  width: 54px;
  padding: 2px;
  vertical-align: middle;
  border: 1px solid #ddd;
  border-radius: 5px;
  background-color: #fff;
}

.filebox .upload-display img {
  display: block;
  max-width: 100%;
  width: 100% \9;
  height: auto;
}

.filebox.bs3-primary label {
  color: #fff;
  background-color: #F56A6A;
  border-color: #F56A6A;
}
		</style>
		<script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-database.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-storage.js"></script>
		<script src="googlelogin.js?useEmulator=true"></script>
		<script>
		function initApp() {
			// Listening for auth state changes.
			firebase.auth().onAuthStateChanged(function(user) {
					if (user) {
						console.log("로그인 상태");
					} else {
							console.log("로그아웃 상태");

				}

			});
		}

		window.onload = function() {
		initApp();
		};

		function list_change(){
			document.getElementById("selected_sports").style.display="none";
			document.getElementById("selected_music").style.display="none";
			document.getElementById("selected_living").style.display="none";
			document.getElementById("selected_computer").style.display="none";
			document.getElementById("selected_game").style.display="none";

		var s = document.getElementById("selected_category");
		var selected_option = s.options[s.selectedIndex].value;

		switch(selected_option){
			case 'A': document.getElementById("selected_sports").style.display="block";
					break;
			case 'B': document.getElementById("selected_music").style.display='block';
					break;
			case 'C': document.getElementById("selected_living").style.display='block';
					break;
			case 'D': document.getElementById("selected_computer").style.display='block';
					break;
			case 'E': document.getElementById("selected_game").style.display='block';
					break;
		}
		}

		function db(){

			var user = firebase.auth().currentUser;
			if (user != null) {
				name = user.displayName;
				email = user.email;
				photoUrl = user.photoURL;
				emailVerified = user.emailVerified;
				uid = user.uid;
			}else{
				console.log("먼가 문제가잇ㅇ므");
			}
			temp = location.href.split("?");
			channel_name = temp[1];

			var channelRef_user = firebase.database().ref('userInfo/'+uid+"/channel_info/");
			var channelRef_list = firebase.database().ref('channel_List/');

			//이름짓기
			var d = new Date();
			var date = d.getFullYear() + "_" + d.getMonth() + "_" + d.getDate() + "_" + d.getHours() + "_" + d.getMinutes();
			var time=date+ "_" + d.getSeconds();
			var storage = firebase.storage();
			var storageRef = storage.ref();
			var videoRef = storageRef.child(uid+"/"+"video_"+time+".mp4");
			var imageRef = storageRef.child(uid+"/"+"video_thumbnail"+time+".jpg");
			var video_name = document.getElementById('ex_input').value;

			var s = document.getElementById("selected_category");
			var selected_option = s.options[s.selectedIndex].value;
			var selected_opt;

			switch(selected_option){
				case 'A':   var s = document.getElementById("selected_sports");
										var selected_opt = s.options[s.selectedIndex].value;
						break;
				case 'B': var s = document.getElementById("selected_music");
										var selected_opt = s.options[s.selectedIndex].value;
						break;
				case 'C': var s = document.getElementById("selected_living");
										var selected_opt = s.options[s.selectedIndex].value;
						break;
				case 'D': var s = document.getElementById("selected_computer");
										var selected_opt = s.options[s.selectedIndex].value;
						break;
				case 'E': var s = document.getElementById("selected_game");
										var selected_opt = s.options[s.selectedIndex].value;
						break;
			}
			console.log("선택된 옵션: "+selected_opt);

			//경로
			var videoFile = document.getElementById('input_video').files[0];
			//var imageFile = document.getElementById('input_image').files[0];
			var uploadTask1 = videoRef.put(videoFile);
			//var uploadTask2 = videoRef.put(imageFile);

			//업로드
			channelRef_user.once('value', (snapshot1)=>{

				snapshot1.forEach((childSnapshot1) => {
				var childKey1 = childSnapshot1.key;
				var childData1 = childSnapshot1.val();

				if(childData1.name == channel_name){

///////////////////////////영상올리기/////////////////////////
					uploadTask1.on('state_changed', function(snapshot){
		        	var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
		       	 console.log('Upload is ' + progress + '% done');
		       	 switch (snapshot.state) {
		       	 case firebase.storage.TaskState.PAUSED: // or 'paused'
		       	 console.log('Upload is paused');
		        	break;
		        	case firebase.storage.TaskState.RUNNING: // or 'running'
		        	console.log('Upload is running');
		        	break;
		        }
		      	}, function(error){


		     	 }, function(){

						 // 레벨기능
						 							var exp;
						 							var lv;
						 							var levelRef = firebase.database().ref('userInfo/'+uid+"/level_info/");
						 							levelRef.once("value",function(snapshot){
						 								exp = snapshot.val().exp;
						 								lv = snapshot.val().level;


						 							exp +=50;
						 							if(Math.pow(2,lv-1)*50 <= exp ){
						 								if(Math.pow(2,lv)*50 <= exp){
						 									lv +=1;

						 									console.log("레벨업 축하드립니다");
						 								}
						 							}

						 							levelRef.update({
						 								exp: exp,
						 								level: lv
						 							});

						 							});






						uploadTask1.snapshot.ref.getDownloadURL().then(function(downloadURL1) {
							channelRef_user.child(childKey1).child("video_info").push({"name": video_name, "time": time, "videopath": downloadURL1, "thumnnailpath": childData1.imgpath,
						"category": selected_opt});

							channelRef_list.once('value', (snapshot3)=>{

								snapshot3.forEach((childSnapshot2) => {
								var childKey2 = childSnapshot2.key;
								var childData2 = childSnapshot2.val();

								if(childData2.name == channel_name){
								channelRef_list.child(childKey2).child("video_info").push({"name":video_name, "time": time, "videopath": downloadURL1, "user": uid, "thumnnailpath": childData1.imgpath,
							"category": selected_opt});
							console.log("T씨발");

// 구독자한테 띄워주기
/*
							firebase.database().ref('channel_List/'+childKey2+'/subscribe/subscribeuser/').once('value',(snapshot77)=>{
								snapshot77.forEach((childSnapshot77) => {
									var userkey77 = childSnapshot77.key;
									console.log(userkey77);
									var message = "구독하신 채널"+name+"동영상이"+time+"에 업로드 되었습니다";

									var subcribelogRef = firebase.database().ref('/userInfo/'+userkey+'/subscribeupdate/');
									subcribelogRef.child(time).set({ message: message });

								});

							});*/
/////////

							}
							});

						});
/*
						uploadTask2.on('state_changed', function(snapshot){
							}, function(error){
						 }, function(){
							uploadTask2.snapshot.ref.getDownloadURL().then(function(downloadURL2) {
							channelRef_user.child(childKey1).child("video_info").push({"name": video_name, "time": time, "videopath": downloadURL1, "thumnnailpath": downloadURL2});


							channelRef_list.once('value', (snapshot3)=>{

								snapshot3.forEach((childSnapshot2) => {
								var childKey2 = childSnapshot2.key;
								var childData2 = childSnapshot2.val();

								if(childData2.name == channel_name){
								channelRef_list.child(childKey2).child("video_info").push({"name":video_name, "time": time, "videopath": downloadURL1, "user": uid, "thumnnailpath": downloadURL2});

							}
							});

						});



							});

						});
*/

						});

					});
///////////////////////////사진올리기///////////////////

/////////////////////////////////////////
				}

				});

			});

}




		</script>

	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">

	<!-- Header -->
<div class="inner">
	<header id="header">
		<a href="index.html" class="logo"><h1>E-tube</h1> </a>

		<!-- Search -->
		<section id="search" class="alt">
			<form method="post" action="channel_select.html">
				<input type="text" onkeypress="if(event.keyCode == 13){search_channel();}"name="query" id="query" placeholder="Search" />
			</form>
		</section>

		<ul class="icons">
			<li><a id="logURL" href="mychannel.html" class="fa fa-user-circle fa-lg"><span class="label" style="color:#3D4449">로그인</span></a></li>
			<script>
				switch (localStorage.getItem("logined")) {
					case 'logined':
							document.getElementById("logURL").innerHTML="마이페이지";
							document.getElementById("logURL").setAttribute('href', 'mychannel.html');
										break;
					case '':
							document.getElementById("logURL").innerHTML="로그인";
							document.getElementById("logURL").setAttribute('href', "javascript:openWindowPop('login.html', 'popup');");
										break;
								default:

					}
			</script>
		</ul>

	</header>

    <section>

      <div class="textbox">
        <label><h3>제목</h3></label>
        <input type="text" id="ex_input">
      </div>
      <div style=" margin-top:55px;">
          <label><h3>카테고리</h3></label>
					<li id='category'>
							<div >
									<select id='selected_category' onchange="list_change()">
											<option value="A">스포츠</option>
											<option value='B'>음악</option>
											<option value='C'>생활</option>
											<option value='D'>컴퓨터</option>
											<option value='E'>게임</option>
									</select>
							</div>
					</li>


							<div >
									<select id='selected_sports'>
											<option value='basketball'>농구</option>
											<option value='baseball'>야구</option>
											<option value='football'>축구</option>
											<option value='swimming'>수영</option>
									</select>
							</div>


							<div >
									<select id='selected_music' style="display:none">
											<option value='piano'>피아노</option>
											<option value='guitar'>기타</option>
											<option value='flute'>플룻</option>
											<option value='violin'>바이올린</option>
									</select>
							</div>

							<div >
									<select id='selected_living' style="display:none">
											<option value='cleaning'>청소</option>
											<option value='saving'>저축</option>
											<option value='cooking'>요리</option>
											<option value='education'>교육</option>
									</select>
							</div>

							<div >
									<select id='selected_computer' style="display:none">
											<option value='web'>웹프로그래밍</option>
											<option value='db'>데이터베이스</option>
											<option value='data_com'>데이터통신</option>
											<option value='language'>언어(자바/C++)</option>
									</select>
							</div>

							<div >
									<select id='selected_game' style="display:none">
											<option value='lol'>롤</option>
											<option value='fifa'>피파</option>
											<option value='maplestory'>메이플</option>
											<option value='cartrider'>카트라이더</option>
									</select>
							</div>
      </div>

<br>
<br>
<br>
<br>
<br>
<br>
			영상 찾아보기: <input type="file" id="input_video"/><br>
			<!--썸네일 찾아보기: <input type="file" id="input_image"/><br>-->
			<br>
			<br>
			<button onclick="db();" >디비 등록</button>

    </section>
      </div></div>
      <div id="sidebar">
      <div class="inner">


      <!-- Menu -->
        <nav id="menu">
          <header class="major">
            <h2 ><div class="image-container" style="height: 120px; width: 160px; float:left; overflow:hidden; display:flex; align-items: center; justify-content: center; margin:20px">
              <a href="#" class="test"> <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSkJocDo9hkBuj_WyT8OOGZ3ha2tWjv5NgoXg&usqp=CAU"></img> </a>
            </div><br>
          채널 이름</h2>
          </header>
          <ul>
            <li><a href="index.html">동영상 업로드</a></li>
            <li><a href="index.html">동영상 삭제</a></li>
            <li><a href="index.html">재생목록 생성 및 삭제 </a></li>
            <li><a href="index.html">로그아웃</a></li>

          </ul>
        </nav>


      </div>
      </div>

      </div>





      <!-- Scripts 아직뭔지 모르겠음-->
      <script src="html5/assets/js/jquery_main.js"></script>
      <script src="html5/assets/js/browser_main.js"></script>
      <script src="html5/assets/js/breakpoints_main.js"></script>
      <script src="html5/assets/js/util.js"></script>
      <script src="html5/assets/js/main.js"></script>

      </body>
      </html>
